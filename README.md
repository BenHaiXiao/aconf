aconf客户端配置中心
一、	现状
客户端目前在版本迭代时，尤其是在进行灰度发布时，由于需要调整很多配置项的值用以观察结果，需要频繁发版。因此，希望能够设计配置中心动态修改配置，提升开发效率。
此外，现有的配置管理是各业务自行管理的，分散在各个平台，不利于管理；同时客户端每次获取配置都需要发送多条请求，加重了客户端压力。

二、	需求
配置下发方式要支持pull和push模式，pull即为配置生效后，用户在进入频道时向服务器发送请求拉取最新数据；push则是在配置后通过广播形式向某一频道发送广播。
配置下发条件可控，例如：只对尾号为9的频道下发配置；
配置下发条件可配置性高，通用性好，例如：同样是通过uid进行条件控制，可以是uid以9结尾的用户，可以是uid在一定范围内的用户，可以是uid为指定内容的一批用户，也可以是随机向500名用户发送等。
能够满足多个应用的多个业务接入。

三、	总体模型
整个系统分为配置下发进程、管理后台和客户端SDK三部分。
如下图所示，管理后台进行应用配置、业务配置和配置项配置的管理。配置下发进程负责处理下发逻辑，为符合下发条件的用户下发配置。客户端SDK封装协议，并在客户端本地缓存配置，方便客户端调用。
 
说明：
（1） Handler是请求处理器，用于接收客户端请求。
（2） 配置管理器持有所有业务对应的配置项列表，每个配置项都有一个Filter列表。每个Filter对应一个下发条件。
（3） 广播线程定时读取RAMCloud中的广播消息。当用户在后台配置广播消息后，该消息将被存储到RAMCloud中，随后广播消息被广播线程读取，并立即在指定频道进行广播。
（4）Thrift线程用于接收本地缓存的更新通知。当管理后台对配置项的修改生效后，会调用Thrift接口向配置下发进程发送更新通知。

四、	拦截器模型
整个需求中，最复杂多变的部分应该就是下发条件了。对于业务功能的配置，不同的业务会有不同的下发条件。对于灰度发布的配置，不同的客户端也有不同的灰度方案。为了适用于各种类型的下发条件，对下发条件进行抽象，可以概括成以下两种类型：
（1）	计数条件
计数型条件适用于“随机500观众灰度”这样的下发条件，对所有下发配置的用户进行记录。
（2）	边界值条件
大多数情况下的条件都可以表示成边界值条件模型。
边界值条件的逻辑结构：
原属性	比较属性	界定值	判定关系
uid	uid	300000	>
sid	sid	9	$
market	market	小米	= / !
uid	爵位	勋爵	>
原属性和比较属性之间使用ValueAdapter转换。转换器可以以模板的形式提供，用户可在后台配置。
对应以上两种类型的条件，设计了两种条件拦截器：
 
计数拦截器通过计数器控制条件计数，超过设置值则停止计数，且请求总是不通过；边界值拦截器通过ValueAdapter将原值转换为比较值，再使用通用判决器将比较值和界定值进行比较。多种拦截器可搭配使用。
所有拦截器和使用到的数据在本地均有缓存，请求时无需读库获取。

综上所述，应用、业务、配置项和拦截器之间的关系如下如所示：
 
举例
1.	例1 对所有进入991频道的小米渠道用户下发配置。
 
2.	例2 对所有进入尾号为9的频道的勋爵用户下发配置。
 
3.	例3 将配置随机发放给500名进入1931频道的观众。
 

五、	逻辑流程
 
业务可配置全局拦截器，若不符合全局条件则直接返回空列表。

六、	部署模型
 
七、	协议约定
1.	PC端通信协议
（1）	请求参数
参数	说明
uid	用户id
sid	顶级频道号
ssid	子频道号
version	客户端版本
bssid	业务id
（2）	返回值
返回值为一个Map结构体，反映简单的键值对应关系：
[
	“key” : “value”,
	……
]
2.	手机客户端通信协议
（1）	请求参数
参数	说明
uid	用户id
sid	顶级频道号
ssid	子频道号
version	客户端版本
market	渠道号
sys	客户端操作系统
bssid	业务id
（2）	返回值
返回值为一个Map结构体，反映简单的键值对应关系：
[
	“key” : “value”,
	……
]

